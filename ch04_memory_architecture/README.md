# Chapter 4: Memory Architecture â­é‡ç‚¹ç« èŠ‚

## ğŸ“– æœ¬ç« å†…å®¹

- GPU å†…å­˜å±‚æ¬¡ç»“æ„
- Global Memory, Shared Memory, Registers
- å†…å­˜å¸¦å®½ä¸å»¶è¿Ÿ
- çŸ©é˜µä¹˜æ³•ï¼ˆNaive ç‰ˆæœ¬ï¼‰

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

è¯»å®Œæœ¬ç« ï¼Œä½ åº”è¯¥èƒ½ï¼š

- [ ] ç”»å‡º GPU å†…å­˜å±‚æ¬¡å›¾
- [ ] ç†è§£ä¸åŒå†…å­˜çš„ç‰¹ç‚¹ï¼ˆé€Ÿåº¦ã€å¤§å°ã€ä½œç”¨åŸŸï¼‰
- [ ] å®ç° Naive çŸ©é˜µä¹˜æ³•
- [ ] ç†è§£ä¸ºä»€ä¹ˆ Naive ç‰ˆæœ¬æ…¢

---

## ğŸ“ æ ¸å¿ƒæ¦‚å¿µ

### GPU å†…å­˜å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GPU                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SM (æµå¤„ç†å™¨)                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ Thread  â”‚  â”‚ Thread  â”‚  â”‚ Thread  â”‚  ...         â”‚   â”‚
â”‚  â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚              â”‚   â”‚
â”‚  â”‚  â”‚â”‚Registerâ”‚â”‚  â”‚â”‚Registerâ”‚â”‚  â”‚â”‚Registerâ”‚â”‚ â† æœ€å¿«     â”‚   â”‚
â”‚  â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚           Shared Memory (48KB)               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚           â† åŒä¸€ Block å†…å…±äº«ï¼Œå¿«            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 L2 Cache                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Global Memory (HBM, å‡ GB~å‡ åGB)          â”‚   â”‚
â”‚  â”‚           â† æœ€å¤§ï¼Œä½†æœ€æ…¢                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…å­˜ç‰¹æ€§å¯¹æ¯”

| å†…å­˜ç±»å‹ | é€Ÿåº¦ | å¤§å° | ä½œç”¨åŸŸ | ç”Ÿå‘½å‘¨æœŸ |
|---------|------|------|--------|---------|
| Register | æœ€å¿« | å¾ˆå° | å•ä¸ªçº¿ç¨‹ | çº¿ç¨‹ |
| Shared Memory | å¿« | 48-96KB/SM | Block å†… | Block |
| L2 Cache | ä¸­ç­‰ | å‡ MB | å…¨å±€ | è‡ªåŠ¨ç®¡ç† |
| Global Memory | æ…¢ | å‡ GB-å‡ åGB | å…¨å±€ | æ‰‹åŠ¨ç®¡ç† |

### å†…å­˜å£°æ˜

```cpp
// Registerï¼ˆé»˜è®¤ï¼‰
int x = 0;  // è‡ªåŠ¨åˆ†é…åˆ° Register

// Shared Memory
__shared__ float sharedData[256];  // Block å†…å…±äº«

// Global Memory
__device__ float globalData[1000];  // å…¨å±€å¯è§

// Constant Memoryï¼ˆåªè¯»ï¼Œæœ‰ç¼“å­˜ï¼‰
__constant__ float constData[100];
```

---

## âœ… æœ¬ç« ä½œä¸šï¼šçŸ©é˜µä¹˜æ³•ï¼ˆNaiveï¼‰

### ä½œä¸šç›®æ ‡

å®ç° C = A Ã— Bï¼Œå…¶ä¸­ï¼š
- A: M Ã— K çŸ©é˜µ
- B: K Ã— N çŸ©é˜µ
- C: M Ã— N çŸ©é˜µ

### ç®—æ³•

```
C[i][j] = Î£ A[i][k] * B[k][j]  (k = 0 to K-1)
```

### è¦æ±‚

1. æ¯ä¸ªçº¿ç¨‹è®¡ç®— C çš„ä¸€ä¸ªå…ƒç´ 
2. ä½¿ç”¨ 2D Grid å’Œ 2D Block
3. ä¸ä½¿ç”¨ Shared Memoryï¼ˆä¸‹ä¸€ç« ä¼˜åŒ–ï¼‰

### ä»£ç æ¡†æ¶

æ–‡ä»¶ï¼š`matmul_naive.cu`

```cuda
// æ¯ä¸ªçº¿ç¨‹è®¡ç®— C çš„ä¸€ä¸ªå…ƒç´ 
__global__ void matmul_naive(float *A, float *B, float *C, 
                              int M, int K, int N) {
    // è®¡ç®—å½“å‰çº¿ç¨‹è´Ÿè´£çš„ C å…ƒç´ ä½ç½®
    int row = blockIdx.y * blockDim.y + threadIdx.y;
    int col = blockIdx.x * blockDim.x + threadIdx.x;
    
    if (row < M && col < N) {
        float sum = 0.0f;
        for (int k = 0; k < K; k++) {
            sum += A[row * K + k] * B[k * N + col];
        }
        C[row * N + col] = sum;
    }
}
```

### åˆ†æï¼šä¸ºä»€ä¹ˆ Naive ç‰ˆæœ¬æ…¢ï¼Ÿ

æ¯ä¸ªçº¿ç¨‹è®¡ç®— C[i][j] éœ€è¦ï¼š
- è¯»å– A çš„ä¸€æ•´è¡Œï¼ˆK æ¬¡ Global Memory è¯»å–ï¼‰
- è¯»å– B çš„ä¸€æ•´åˆ—ï¼ˆK æ¬¡ Global Memory è¯»å–ï¼‰
- å…± 2K æ¬¡ Global Memory è®¿é—®ï¼

é—®é¢˜ï¼š
1. **å¤§é‡é‡å¤è¯»å–**ï¼šç›¸é‚»çº¿ç¨‹è¯»å–äº†å¾ˆå¤šç›¸åŒçš„æ•°æ®
2. **å†…å­˜å¸¦å®½ç“¶é¢ˆ**ï¼šGlobal Memory å¤ªæ…¢

è§£å†³æ–¹æ¡ˆï¼š**Shared Memory Tiling**ï¼ˆä¸‹ä¸€ç« ï¼‰

---

## ğŸ¯ æ£€æŸ¥ç‚¹

- [ ] ç†è§£ 2D Grid/Block çš„ç´¢å¼•è®¡ç®—
- [ ] ç†è§£çŸ©é˜µåœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ï¼ˆRow-majorï¼‰
- [ ] èƒ½è§£é‡Šä¸ºä»€ä¹ˆ Naive ç‰ˆæœ¬æ…¢
- [ ] çŸ¥é“ Shared Memory å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜

---

**å®Œæˆåç»§ç»­ Chapter 5ï¼**
